var gl;function initGL(a){try{gl=a.getContext("experimental-webgl");gl.viewportWidth=a.width;gl.viewportHeight=a.height}catch(b){}if(!gl){alert("Could not initialise WebGL, sorry :-(")}}function getShader(e,f){var b=document.getElementById(f);if(!b){return null}var d="";var a=b.firstChild;while(a){if(a.nodeType==3){d+=a.textContent}a=a.nextSibling}var c;if(b.type=="x-shader/x-fragment"){c=e.createShader(e.FRAGMENT_SHADER)}else{if(b.type=="x-shader/x-vertex"){c=e.createShader(e.VERTEX_SHADER)}else{return null}}e.shaderSource(c,d);e.compileShader(c);if(!e.getShaderParameter(c,e.COMPILE_STATUS)){alert(e.getShaderInfoLog(c));return null}return c}var shaderProgram;var Shaders={lineShader:null,worldShader:null};function initShaders(){var a=getShader(gl,"shader-fs");var b=getShader(gl,"shader-vs");Shaders.worldShader=gl.createProgram();gl.attachShader(Shaders.worldShader,b);gl.attachShader(Shaders.worldShader,a);gl.linkProgram(Shaders.worldShader);if(!gl.getProgramParameter(Shaders.worldShader,gl.LINK_STATUS)){alert("Could not initialise shaders")}gl.useProgram(Shaders.worldShader);Shaders.worldShader.vertexPositionAttribute=gl.getAttribLocation(Shaders.worldShader,"aVertexPosition");gl.enableVertexAttribArray(Shaders.worldShader.vertexPositionAttribute);Shaders.worldShader.vertexNormalAttribute=gl.getAttribLocation(Shaders.worldShader,"aVertexNormal");gl.enableVertexAttribArray(Shaders.worldShader.vertexNormalAttribute);Shaders.worldShader.vertexTangentAttribute=gl.getAttribLocation(Shaders.worldShader,"aVertexTangent");gl.enableVertexAttribArray(Shaders.worldShader.vertexTangentAttribute);Shaders.worldShader.vertexBiTangentAttribute=gl.getAttribLocation(Shaders.worldShader,"aVertexBiTangent");gl.enableVertexAttribArray(Shaders.worldShader.vertexBiTangentAttribute);Shaders.worldShader.vertexColorAttribute=gl.getAttribLocation(Shaders.worldShader,"aVertexColor");gl.enableVertexAttribArray(Shaders.worldShader.vertexColorAttribute);Shaders.worldShader.textureCoordAttribute=gl.getAttribLocation(Shaders.worldShader,"aTextureCoord");gl.enableVertexAttribArray(Shaders.worldShader.textureCoordAttribute);Shaders.worldShader.pMatrixUniform=gl.getUniformLocation(Shaders.worldShader,"uPMatrix");Shaders.worldShader.mvMatrixUniform=gl.getUniformLocation(Shaders.worldShader,"uMVMatrix");Shaders.worldShader.samplerUniform=gl.getUniformLocation(Shaders.worldShader,"uSampler");Shaders.worldShader.useLightingUniform=gl.getUniformLocation(Shaders.worldShader,"uUseLighting");Shaders.worldShader.ambientColorUniform=gl.getUniformLocation(Shaders.worldShader,"uAmbientColor");Shaders.worldShader.lightDirectionUniform=gl.getUniformLocation(Shaders.worldShader,"uLightingDirection");Shaders.worldShader.directionalColorUniform=gl.getUniformLocation(Shaders.worldShader,"uDirectionalColor");Shaders.worldShader.nMatrixUniform=gl.getUniformLocation(Shaders.worldShader,"uNMatrix");Shaders.worldShader.vMatrixUniform=gl.getUniformLocation(Shaders.worldShader,"uVMatrix")}function handleLoadedTexture(a){gl.bindTexture(gl.TEXTURE_2D,a);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a.image);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.bindTexture(gl.TEXTURE_2D,null)}var globeBumpMap;function initTextures(a){globeBumpMap=gl.createTexture();globeBumpMap.image=new Image();globeBumpMap.image.onload=function(){handleLoadedTexture(globeBumpMap)};globeBumpMap.image.src=a}function mvPushMatrix(){var a=mat4.create();mat4.copy(a,mvMatrix);mvMatrixStack.push(a)}function mvPopMatrix(){if(mvMatrixStack.length==0){throw"Invalid popMatrix!"}mvMatrix=mvMatrixStack.pop()}function setMatrixUniforms(a){gl.uniformMatrix4fv(a.pMatrixUniform,false,pMatrix);gl.uniformMatrix4fv(a.mvMatrixUniform,false,mvMatrix);gl.uniformMatrix4fv(a.vMatrixUniform,false,vMatrix);gl.uniform1i(a.useLightingUniform,displaySettings.lightingEnabled);gl.uniform3fv(a.ambientColorUniform,displaySettings.lightAmbient);gl.uniform3fv(a.lightDirectionUniform,lightDirection);gl.uniform3fv(a.directionalColorUniform,displaySettings.lightDirectionColor)}function setMatrixLightingUniforms(a){var b=mat3.create();mat4.toMat3(b,mvMatrix);mat3.invert(b,b);mat3.transpose(b,b);gl.uniformMatrix3fv(a.nMatrixUniform,false,b)}function drawScene(){gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);gl.clearColor(1,1,1,1);gl.clear(gl.COLOR_BUFFER_BIT);mat4.identity(mvMatrix);mvPushMatrix();var c=0;if(displaySettings.pacificCenter&&displaySettings.globeView=="2d"){c=-180}var a=gl.viewportWidth/gl.viewportHeight;if(displaySettings.globeView=="3d"||displaySettings.globeView=="2d"){mat4.perspective(pMatrix,45,a,0.1,-1000);mat4.translate(mvMatrix,mvMatrix,[xMovement+c,yMovement,globeDistance+zoomLevel])}else{if(displaySettings.globeView=="ortho"){var b=-1*zoomLevel/(80*2);mat4.ortho(pMatrix,(-a*80)*b,(a*80)*b,(-1*80)*b,(1*80)*b,-1000,1000);mat4.translate(mvMatrix,mvMatrix,[xMovement+c,yMovement,-1000])}}mat4.multiply(mvMatrix,mvMatrix,earthRotationMatrix);lightDirection=vec3.clone(displaySettings.lightDirection);if(displaySettings.globeView=="3d"||displaySettings.globeView=="ortho"){mat4.rotate(mvMatrix,mvMatrix,degToRad(-90),[1,0,0])}mat4.copy(vMatrix,mvMatrix);mvPushMatrix();if(WorldVertex.PositionBuffer.length>0){SetAllGlBuffers(Shaders.worldShader,WorldVertex,gl.TRIANGLES)}mvPopMatrix();mvPushMatrix();if(LineVertex.PositionBuffer.length>0){SetAllGlBuffers(Shaders.worldShader,LineVertex,gl.LINES)}mvPopMatrix()}function initBuffers(){latLonBuffers();lineBuffers();worldBuffers();if(RawData.Lat.length>0){drawLegend()}}function tick(){requestAnimFrame(tick);drawScene();animate()}function SetOptionsFromUrl(b){var d=new URI(window.location.href);var e=d.search(true);if(e.hasOwnProperty("rMatrix")){var s=e.rMatrix.split(",");for(var r=0;r<s.length;r++){earthRotationMatrix[r]=parseFloat(s[r])}}if(e.hasOwnProperty("rMatrixX")){var j=e.rMatrixX.split(",");for(var r=0;r<s.length;r++){earthRotationMatrix_x[r]=parseFloat(j[r])}}if(e.hasOwnProperty("rMatrixY")){var h=e.rMatrixY.split(",");for(var r=0;r<s.length;r++){earthRotationMatrix_y[r]=parseFloat(h[r])}}if(e.hasOwnProperty("xMov")){xMovement=parseFloat(e.xMov)}if(e.hasOwnProperty("yMov")){yMovement=parseFloat(e.yMov)}if(e.hasOwnProperty("zoom")){zoomLevel=parseFloat(e.zoom)}LayerSettings.Level_ID=1;if(e.hasOwnProperty("level")){LayerSettings.Level_ID=parseInt(e.level)}if(e.hasOwnProperty("date")){ChangeDate(e.date)}var l;if(e.hasOwnProperty("database")){var k=GetDatasetById(parseInt(e.database));if(e.hasOwnProperty("date")){l=ChangeDatasetDate(k,LayerSettings.CurrDate,LayerSettings.Level_ID)}else{l=ChangeDataset(k,LayerSettings.Level_ID)}}if(e.hasOwnProperty("colorMap")){var n=ColorMaps[parseInt(e.colorMap)];displaySettings.functionForColorMap=n.Function;displaySettings.currColormapName=n.FullName}var o;if(e.hasOwnProperty("bumpMapping")){o=changeBumpMapping(e.bumpMapping)}var v;if(e.hasOwnProperty("geoLines")){v=ChangeMenuOption(e.geoLines,MenuOptions.GeoLines,false,null)}var c;if(e.hasOwnProperty("globe")){c=ChangeMenuOption(e.globe,MenuOptions.Globe,false,null)}var g;if(e.hasOwnProperty("smoothGrid")){if(e.smoothGrid=="true"){g=ChangeMenuOption("true",MenuOptions.SmoothGrid,false,null)}}var t;if(e.hasOwnProperty("center")){if(e.center=="true"){t=ChangeMenuOption("true",MenuOptions.PacificCentered,false,null)}}var f;if(e.hasOwnProperty("timeZones")){if(e.timeZones=="true"){f=ChangeMenuOption("true",MenuOptions.TimeZone,false,null)}}var u;if(e.hasOwnProperty("latlon")){if(e.latlon=="true"){u=ChangeMenuOption("true",MenuOptions.LatLon,false,null)}}var m;if(e.hasOwnProperty("rivers")){m=ChangeMenuOption(e.rivers,MenuOptions.Rivers,false,null)}var q;if(e.hasOwnProperty("coasts")){q=ChangeMenuOption(e.coasts,MenuOptions.Coasts,false,null)}var a;if(e.hasOwnProperty("lakes")){a=ChangeMenuOption(e.lakes,MenuOptions.Lakes,false,null)}var p;if(e.hasOwnProperty("minorIslands")){p=ChangeMenuOption(e.minorIslands,MenuOptions.MinorIslands,false,null)}$.when(l,f,m,p,o,a,q,t,c,u,v).then(function(){if(e.hasOwnProperty("level")){changeLevel(LayerSettings.Level_ID.toString());$("#levelRadio"+LayerSettings.Level_ID).prop("checked",true).button("refresh")}if(e.hasOwnProperty("globe")){GlobeViewSettings(e.globe,false);displaySettings.globeView=e.globe;var i=GetMenuOption(MenuOptions.Globe,e.globe).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("bumpMapping")){if(e.bumpMapping.length>0){displaySettings.lightingEnabled=true}else{displaySettings.lightingEnabled=false}var i=GetMenuOption(MenuOptions.BumpMapping,e.bumpMapping).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("geoLines")){if(e.geoLines=="true"){displaySettings.geoLines=true}else{displaySettings.geoLines=false}var i=GetMenuOption(MenuOptions.GeoLines,e.geoLines).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("smoothGrid")){if(e.smoothGrid=="true"){displaySettings.smoothGridBoxValues=true}else{displaySettings.smoothGridBoxValues=false}var i=GetMenuOption(MenuOptions.SmoothGrid,e.smoothGrid.toString()).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("center")){if(e.center=="true"){displaySettings.pacificCenter=true}else{displaySettings.pacificCenter=false}var i=GetMenuOption(MenuOptions.PacificCentered,displaySettings.pacificCenter.toString()).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("timeZones")){if(e.timeZones=="true"){displaySettings.timeZones=true}else{displaySettings.timeZones=false}var i=GetMenuOption(MenuOptions.TimeZone,e.timeZones.toString()).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("latlon")){if(e.latlon=="true"){displaySettings.latLons=true}else{displaySettings.latLons=false}var i=GetMenuOption(MenuOptions.LatLon,e.latlon.toString()).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("rivers")){if(e.rivers.length>0){displaySettings.rivers=true}else{displaySettings.rivers=false}var i=GetMenuOption(MenuOptions.Rivers,e.rivers).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("coasts")){displaySettings.CoastsType=e.coasts;if(e.coasts.length>0){displaySettings.coasts=true}else{displaySettings.coasts=false}var i=GetMenuOption(MenuOptions.Coasts,e.coasts).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("lakes")){displaySettings.LakesType=e.coasts;if(e.lakes.length>0){displaySettings.lakes=true}else{displaySettings.lakes=false}var i=GetMenuOption(MenuOptions.Lakes,e.lakes).id;$("#"+i).prop("checked",true).button("refresh")}if(e.hasOwnProperty("minorIslands")){if(e.minorIslands=="true"){displaySettings.minorIslands=true}else{displaySettings.minorIslands=false}var i=GetMenuOption(MenuOptions.MinorIslands,displaySettings.minorIslands.toString()).id;$("#"+i).prop("checked",true).button("refresh")}b()})}function webGLStart(){var e=document.getElementById("dynamicMenu");e.appendChild(generateList(MenuData));$("#datasetMenu").menu({select:function(f,g){ChangeDatasetMenu(g,1)}});var e=document.getElementById("colormapDynamicMenu");e.appendChild(generateColorMapList(ColorMenuData));$("#colormapMenu").menu({select:function(f,g){ChangeColorMap(g,function(){worldBuffers();drawLegend()})}});displaySettings.lightDirection=vec3.create();vec3.normalize(displaySettings.lightDirection,[-1,0,0]);displaySettings.lightAmbient=[0.2,0.2,0.2];displaySettings.lightDirectionColor=[1,1,1];var b=document.getElementById("webgl-canvas");var a=Math.min(document.documentElement.clientWidth,window.innerWidth||0)-20;var c=Math.min(document.documentElement.clientHeight,window.innerHeight||0)-20;b.width=a;b.height=c;initGL(b);initShaders();initBuffers();initTextures("images/earth_normalmap_flat_8192x4096.jpg");var d=document.getElementById("timeSeriesBox");d.width=a;d.height=c;gl.clearColor(0,0,0,1);gl.enable(gl.DEPTH_TEST);document.onmouseup=function(){handleMouseUp(b,event)};b.onmousedown=handleMouseDown;document.onmousemove=handleMouseMove;b.addEventListener("mousewheel",handleMouseWheel,false);document.addEventListener("touchend",function(){handleMouseUp(b,event)},false);b.addEventListener("touchstart",handleMouseDown,false);document.addEventListener("touchmove",handleMouseMove,false);$("div#divTitle").text(LayerSettings.FullName);zoomLevel=-165;SetOptionsFromUrl(function(){initBuffers()});tick()};